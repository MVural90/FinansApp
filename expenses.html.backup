<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finans Yönetimi - Giderler</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        .tab-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1rem;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .tab-btn.active {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
        }

        .tab-btn:hover {
            color: var(--text-primary);
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="container nav-container">
            <a href="index.html" class="logo">FinansApp</a>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Özet</a>
                <a href="income.html" class="nav-link">Gelirler</a>
                <a href="expenses.html" class="nav-link active">Giderler</a>
                <a href="budget.html" class="nav-link">Bütçe</a>
            </div>
        </div>
    </nav>

    <main class="container main-content">
        <div class="grid-layout" style="display: grid; grid-template-columns: 350px 1fr; gap: 2rem;">

            <!-- Add Expense Form -->
            <div class="card">
                <h3 class="mb-4" id="form-title">Gider Ekle</h3>

                <div class="tab-buttons">
                    <button type="button" class="tab-btn active" onclick="setExpenseType('credit_card')">Kredi
                        Kartı</button>
                    <button type="button" class="tab-btn" onclick="setExpenseType('loan')">Kredi</button>
                    <button type="button" class="tab-btn" onclick="setExpenseType('cash')">Nakit</button>
                </div>

                <form id="expense-form" onsubmit="handleExpenseSubmit(event)">
                    <input type="hidden" id="expense-id">
                    <input type="hidden" id="expense-type" value="credit_card">

                    <div class="form-group" id="card-select-group">
                        <label class="form-label">Kart Seçimi</label>
                        <select id="card-select" class="form-control">
                            <!-- Options populated by JS -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tutar</label>
                        <input type="number" id="amount" class="form-control" required step="0.01" placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Açıklama</label>
                        <input type="text" id="description" class="form-control" required placeholder="Örn: Market">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tarih</label>
                        <input type="date" id="date" class="form-control" required>
                    </div>

                    <div id="installments-group">
                        <div class="form-group">
                            <label class="form-label">Taksit Sayısı</label>
                            <input type="number" id="installments" class="form-control" value="1" min="1" max="120">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Taksit Tipi</label>
                            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="installmentType" value="total" checked> Toplam Tutar
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="installmentType" value="monthly"> Aylık Tutar
                                </label>
                            </div>
                            <small class="text-secondary" style="display: block; margin-top: 0.5rem;">
                                "Toplam Tutar" seçerseniz girilen tutar taksitlere bölünür.<br>
                                "Aylık Tutar" seçerseniz girilen tutar her ay için ayrı ayrı eklenir.
                            </small>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button type="submit" id="submit-btn" class="btn btn-primary w-full">Harcama Ekle</button>
                        <button type="button" id="cancel-btn" onclick="resetForm()" class="btn w-full"
                            style="display: none; background: var(--surface);">İptal</button>
                    </div>
                </form>
            </div>

            <!-- Expense List & Summary -->
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <div class="tab-buttons" style="margin-bottom: 0; border-bottom: none; padding-bottom: 0;">
                        <button type="button" class="tab-btn active" onclick="setViewType('list')">Liste</button>
                        <button type="button" class="tab-btn" onclick="setViewType('summary')">Kart Özeti</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="changeMonth(-1)" class="btn" style="padding: 0.2rem 0.6rem;">&lt;</button>
                        <input type="month" id="filter-month" class="form-control" onchange="render()">
                        <button onclick="changeMonth(1)" class="btn" style="padding: 0.2rem 0.6rem;">&gt;</button>
                    </div>
                </div>

                <!-- List View -->
                <div id="view-list">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="padding: 1rem;">Tarih</th>
                                    <th style="padding: 1rem;">Tür</th>
                                    <th style="padding: 1rem;">Açıklama</th>
                                    <th style="padding: 1rem; text-align: right;">Tutar</th>
                                    <th style="padding: 1rem;"></th>
                                </tr>
                            </thead>
                            <tbody id="expense-list">
                                <!-- Items will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <h4 class="text-secondary">Toplam Gider:</h4>
                        <h4 id="total-expense" class="text-danger">0.00 TL</h4>
                    </div>
                </div>

                <!-- Summary View -->
                <div id="view-summary" class="hidden">
                    <h4 class="mb-4 text-secondary">Bu Ayki Kart Harcamaları</h4>
                    <div id="card-totals-list" style="display: flex; flex-direction: column; gap: 1rem;">
                        <!-- Card totals will be populated here -->
                    </div>
                    <div id="no-card-expenses" class="text-secondary text-center hidden" style="padding: 2rem;">
                        Bu ay için kredi kartı harcaması bulunmuyor.
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Detail Modal -->
    <div id="detail-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 500px; position: relative;">
            <button onclick="closeModal()"
                style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.5rem;">&times;</button>
            <h3 class="mb-4">Harcama Detayı</h3>
            <div id="modal-content"></div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        let currentType = 'credit_card';
        let currentView = 'list';

        function initPage() {
            document.getElementById('date').valueAsDate = new Date();
            const today = new Date();
            const monthStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('filter-month').value = monthStr;

            populateCards();
            render();
        }

        function setViewType(view) {
            currentView = view;

            // Update Tab Styles
            const buttons = document.querySelectorAll('.card .tab-buttons .tab-btn');
            buttons.forEach(btn => {
                if (btn.textContent === (view === 'list' ? 'Liste' : 'Kart Özeti')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Show/Hide Content
            if (view === 'list') {
                document.getElementById('view-list').classList.remove('hidden');
                document.getElementById('view-summary').classList.add('hidden');
            } else {
                document.getElementById('view-list').classList.add('hidden');
                document.getElementById('view-summary').classList.remove('hidden');
            }
        }

        function changeMonth(delta) {
            const input = document.getElementById('filter-month');
            const [year, month] = input.value.split('-').map(Number);
            const date = new Date(year, month - 1 + delta, 1);
            input.value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            render();
        }

        function populateCards() {
            const select = document.getElementById('card-select');
            select.innerHTML = '';
            state.cards.forEach(card => {
                const option = document.createElement('option');
                option.value = card.id;
                option.textContent = card.name;
                select.appendChild(option);
            });

            if (state.cards.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "Kart Bulunamadı (Önce Kart Ekleyin)";
                select.appendChild(option);
            }
        }

        function setExpenseType(type) {
            currentType = type;
            document.getElementById('expense-type').value = type;

            // Update UI tabs
            const typeTabs = document.querySelectorAll('#form-title + .tab-buttons .tab-btn');
            typeTabs.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Show/Hide inputs based on type
            const instGroup = document.getElementById('installments-group');
            const cardGroup = document.getElementById('card-select-group');

            if (type === 'cash') {
                instGroup.style.display = 'none';
                cardGroup.style.display = 'none';
                document.getElementById('installments').value = 1;
            } else if (type === 'loan') {
                instGroup.style.display = 'block';
                cardGroup.style.display = 'none';
            } else { // credit_card
                instGroup.style.display = 'block';
                cardGroup.style.display = 'block';
            }
        }

        function handleExpenseSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('expense-id').value;
            const type = document.getElementById('expense-type').value;
            const cardId = document.getElementById('card-select').value;
            const amount = document.getElementById('amount').value;
            const description = document.getElementById('description').value;
            const date = document.getElementById('date').value;
            const installments = document.getElementById('installments').value;
            const installmentType = document.querySelector('input[name="installmentType"]:checked').value;

            if (type === 'credit_card' && !cardId) {
                alert('Lütfen bir kredi kartı seçin veya Özet sayfasından yeni kart ekleyin.');
                return;
            }

            const data = {
                type,
                cardId: type === 'credit_card' ? cardId : null,
                amount,
                description,
                date,
                installments,
                installmentType
            };

            if (id) {
                updateExpense(id, data);
            } else {
                addExpense(type, data.cardId, amount, description, date, installments, installmentType);
            }

            resetForm();
            render();
        }

        function editExpense(id) {
            const item = state.expenses.find(e => e.id === id);
            if (item) {
                // Switch to correct tab
                setExpenseType(item.type);
                // Manually update active class for type tabs
                const typeTabs = document.querySelectorAll('#form-title + .tab-buttons .tab-btn');
                typeTabs.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.toLowerCase().includes(item.type === 'credit_card' ? 'kredi kartı' : item.type === 'loan' ? 'kredi' : 'nakit')) {
                        btn.classList.add('active');
                    }
                });

                document.getElementById('expense-id').value = item.id;
                document.getElementById('amount').value = item.amount;
                document.getElementById('description').value = item.description.replace(/\s\(\d+\/\d+\)$/, '');
                document.getElementById('date').value = item.date;

                if (item.cardId) {
                    document.getElementById('card-select').value = item.cardId;
                }

                // Installments
                if (item.installments) {
                    document.getElementById('installments').value = item.installments.count;
                    if (item.installments.type) {
                        document.querySelector(`input[name="installmentType"][value="${item.installments.type}"]`).checked = true;
                    }
                }

                document.getElementById('form-title').textContent = 'Gider Düzenle';
                document.getElementById('submit-btn').textContent = 'Güncelle';
                document.getElementById('cancel-btn').style.display = 'block';
            }
        }

        function deleteExpenseHandler(id) {
            if (confirm('Bu harcamayı silmek istediğinize emin misiniz?')) {
                deleteExpense(id);
                render();
            }
        }

        function resetForm() {
            document.getElementById('expense-form').reset();
            document.getElementById('expense-id').value = '';
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('installments').value = 1;
            document.getElementById('form-title').textContent = 'Gider Ekle';
            document.getElementById('submit-btn').textContent = 'Harcama Ekle';
            document.getElementById('cancel-btn').style.display = 'none';
            // Reset type
            setExpenseType(currentType);
            // Re-select current tab visually
            const typeTabs = document.querySelectorAll('#form-title + .tab-buttons .tab-btn');
            typeTabs.forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(currentType === 'credit_card' ? 'kredi kartı' : currentType === 'loan' ? 'kredi' : 'nakit')) {
                    btn.classList.add('active');
                }
            });
        }

        function render() {
            const filterVal = document.getElementById('filter-month').value;
            const [year, month] = filterVal.split('-').map(Number);

            const totals = getMonthlyTotals(year, month - 1);
            document.getElementById('total-expense').textContent = formatCurrency(totals.expense);

            // Calculate monthly net worth (income - expense for this month)
            const monthlyNet = totals.income - totals.expense;
            const monthlyNetEl = document.getElementById('monthly-net');
            monthlyNetEl.textContent = formatCurrency(monthlyNet);
            monthlyNetEl.className = monthlyNet >= 0 ? 'text-success' : 'text-danger';

            const list = document.getElementById('expense-list');
            list.innerHTML = '';

            const start = new Date(year, month - 1, 1);
            const end = new Date(year, month, 0);

            const filteredExpenses = state.expenses
                .filter(e => {
                    const d = new Date(e.date);
                    return d >= start && d <= end;
                })
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            // Calculate Card Totals for this Month
            const cardTotals = {};
            filteredExpenses.forEach(e => {
                if (e.type === 'credit_card' && e.cardId) {
                    if (!cardTotals[e.cardId]) cardTotals[e.cardId] = 0;
                    cardTotals[e.cardId] += parseFloat(e.amount);
                }
            });

            // Render Card Totals in Summary View
            const cardTotalsList = document.getElementById('card-totals-list');
            const noCardExpenses = document.getElementById('no-card-expenses');

            if (cardTotalsList) {
                cardTotalsList.innerHTML = '';

                if (Object.keys(cardTotals).length > 0) {
                    noCardExpenses.classList.add('hidden');
                    Object.keys(cardTotals).forEach(cardId => {
                        const card = state.cards.find(c => c.id === cardId);
                        const cardName = card ? card.name : 'Silinmiş Kart';
                        const total = cardTotals[cardId];

                        // Calculate payment due date
                        let paymentDueText = '';
                        if (card && card.paymentDay) {
                            paymentDueText = `Son Ödeme: ${card.paymentDay}. gün`;
                        } else if (card && card.cutoffDay) {
                            paymentDueText = `Kesim: ${card.cutoffDay}. gün`;
                        }

                        const div = document.createElement('div');
                        div.style.background = 'rgba(255,255,255,0.05)';
                        div.style.padding = '1rem';
                        div.style.borderRadius = '0.5rem';
                        div.style.display = 'flex';
                        div.style.justifyContent = 'space-between';
                        div.style.alignItems = 'center';
                        <div style="background: rgba(255,255,255,0.05); padding: 0.5rem; border-radius: 4px;">
                            <small class="text-secondary">Taksit Bilgisi</small>
                            <p>${item.installments.current}. Taksit (Toplam ${item.installments.count})</p>
                        </div>
                        ` : ''}
                </div>
            `;

                        modal.style.display = 'flex';
                    }

        function closeModal() {
                            document.getElementById('detail-modal').style.display = 'none';
                        }

        window.onclick = function (event) {
                            const modal = document.getElementById('detail-modal');
                            if (event.target == modal) {
                                modal.style.display = 'none';
                            }
                        }
    </script>
</body>

</html>