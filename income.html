<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finans Yönetimi - Gelirler</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>

<body>
    <nav class="navbar">
        <div class="container nav-container">
            <a href="index.html" class="logo">FinansApp</a>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Özet</a>
                <a href="income.html" class="nav-link active">Gelirler</a>
                <a href="expenses.html" class="nav-link">Giderler</a>
                <a href="budget.html" class="nav-link">Bütçe</a>
            </div>
        </div>
    </nav>

    <main class="container main-content">
        <div class="grid-layout" style="display: grid; grid-template-columns: 350px 1fr; gap: 2rem;">

            <!-- Add Income Form -->
            <div class="card">
                <h3 class="mb-4" id="form-title">Gelir Ekle</h3>
                <form id="income-form" onsubmit="handleIncomeSubmit(event)">
                    <input type="hidden" id="income-id">

                    <div class="form-group">
                        <label class="form-label">Hesap Seçimi</label>
                        <select id="account-select" class="form-control" required>
                            <!-- Options populated by JS -->
                        </select>
                        <small class="text-secondary" style="display: block; margin-top: 0.5rem;">Para hangi hesaba
                            girecek?</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tutar</label>
                        <input type="number" id="amount" class="form-control" required step="0.01" placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Açıklama</label>
                        <input type="text" id="description" class="form-control" required placeholder="Örn: Maaş">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tarih</label>
                        <input type="date" id="date" class="form-control" required>
                    </div>

                    <div class="flex gap-2">
                        <button type="submit" id="submit-btn" class="btn btn-primary w-full">Ekle</button>
                        <button type="button" id="cancel-btn" onclick="resetForm()" class="btn w-full"
                            style="display: none; background: var(--surface);">İptal</button>
                    </div>
                </form>
            </div>

            <!-- Income List -->
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h3>Gelir Listesi</h3>
                    <div class="flex items-center gap-2">
                        <button onclick="changeMonth(-1)" class="btn" style="padding: 0.2rem 0.6rem;">&lt;</button>
                        <input type="month" id="filter-month" class="form-control" style="width: auto;"
                            onchange="render()">
                        <button onclick="changeMonth(1)" class="btn" style="padding: 0.2rem 0.6rem;">&gt;</button>
                    </div>
                </div>

                <div class="mb-4 text-right">
                    <span class="text-secondary">Toplam: </span>
                    <span id="total-income" class="text-success"
                        style="font-size: 1.2rem; font-weight: bold;">₺0,00</span>
                </div>

                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr
                                style="text-align: left; border-bottom: 1px solid var(--border); color: var(--text-secondary);">
                                <th style="padding: 1rem;">Tarih</th>
                                <th style="padding: 1rem;">Hesap</th>
                                <th style="padding: 1rem;">Açıklama</th>
                                <th style="padding: 1rem; text-align: right;">Tutar</th>
                                <th style="padding: 1rem;"></th>
                            </tr>
                        </thead>
                        <tbody id="income-list">
                            <!-- Items will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="js/app.js"></script>
    <script>
        function initPage() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            document.getElementById('date').value = dateStr;

            const monthStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('filter-month').value = monthStr;

            populateAccounts();
            render();
        }

        function changeMonth(delta) {
            const input = document.getElementById('filter-month');
            const [year, month] = input.value.split('-').map(Number);
            const date = new Date(year, month - 1 + delta, 1);
            input.value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            render();
        }

        function populateAccounts() {
            const select = document.getElementById('account-select');
            select.innerHTML = '';
            state.accounts.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.id;
                option.textContent = acc.name;
                select.appendChild(option);
            });

            if (state.accounts.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "Hesap Bulunamadı (Önce Hesap Ekleyin)";
                select.appendChild(option);
            }
        }

        function handleIncomeSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('income-id').value;
            const accountId = document.getElementById('account-select').value;
            const amount = document.getElementById('amount').value;
            const description = document.getElementById('description').value;
            const date = document.getElementById('date').value;

            if (!accountId) {
                alert('Lütfen bir hesap seçin veya Özet sayfasından yeni hesap ekleyin.');
                return;
            }

            if (id) {
                updateIncome(id, { accountId, amount, description, date });
            } else {
                addIncome(accountId, amount, description, date);
            }

            resetForm();
            render();
        }

        function editIncome(id) {
            const item = state.incomes.find(i => i.id === id);
            if (item) {
                document.getElementById('income-id').value = item.id;
                document.getElementById('account-select').value = item.accountId;
                document.getElementById('amount').value = item.amount;
                document.getElementById('description').value = item.description;
                document.getElementById('date').value = item.date;

                document.getElementById('form-title').textContent = 'Gelir Düzenle';
                document.getElementById('submit-btn').textContent = 'Güncelle';
                document.getElementById('cancel-btn').style.display = 'block';
            }
        }

        function deleteIncomeHandler(id) {
            if (confirm('Bu geliri silmek istediğinize emin misiniz?')) {
                deleteIncome(id);
                render();
            }
        }

        function resetForm() {
            document.getElementById('income-form').reset();
            document.getElementById('income-id').value = '';
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('form-title').textContent = 'Gelir Ekle';
            document.getElementById('submit-btn').textContent = 'Ekle';
            document.getElementById('cancel-btn').style.display = 'none';
        }

        function render() {
            const filterVal = document.getElementById('filter-month').value;
            const [year, month] = filterVal.split('-').map(Number);

            const totals = getMonthlyTotals(year, month - 1);
            document.getElementById('total-income').textContent = formatCurrency(totals.income);

            const list = document.getElementById('income-list');
            list.innerHTML = '';

            const start = new Date(year, month - 1, 1);
            const end = new Date(year, month, 0);

            const filteredIncomes = state.incomes
                .filter(i => {
                    const d = new Date(i.date);
                    return d >= start && d <= end;
                })
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filteredIncomes.length === 0) {
                list.innerHTML = `<tr>
                    <td colspan="5" style="padding: 1rem; text-align: center; color: var(--text-secondary);">Bu ay için kayıt bulunamadı.</td>
                </tr>`;
                return;
            }

            filteredIncomes.forEach(item => {
                const account = state.accounts.find(a => a.id === item.accountId);
                const accountName = account ? account.name : 'Bilinmeyen Hesap';

                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid var(--border)';
                tr.innerHTML = `
                    <td style="padding: 1rem;">${new Date(item.date).toLocaleDateString('tr-TR')}</td>
                    <td style="padding: 1rem;"><span style="font-size: 0.8rem; padding: 0.2rem 0.5rem; background: rgba(255,255,255,0.1); border-radius: 4px;">${accountName}</span></td>
                    <td style="padding: 1rem;">${item.description}</td>
                    <td style="padding: 1rem; text-align: right;" class="text-success">+${formatCurrency(item.amount)}</td>
                    <td style="padding: 1rem;">
                        <button onclick="editIncome('${item.id}')" class="btn" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">Düzenle</button>
                        <button onclick="deleteIncomeHandler('${item.id}')" class="btn text-danger" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">Sil</button>
                    </td>
                `;
                list.appendChild(tr);
            });
        }
    </script>
</body>

</html>